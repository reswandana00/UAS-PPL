name: DamnCRUD Test Suite CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch: # Allow manual trigger

env:
  PYTHON_VERSION: "3.11"

jobs:
  test:
    name: Run Selenium Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          # Install Firefox ESR from Mozilla repository
          sudo install -d -m 0755 /etc/apt/keyrings
          wget -q https://packages.mozilla.org/apt/repo-signing-key.gpg -O- | sudo tee /etc/apt/keyrings/packages.mozilla.org.asc > /dev/null
          echo "deb [signed-by=/etc/apt/keyrings/packages.mozilla.org.asc] https://packages.mozilla.org/apt mozilla main" | sudo tee -a /etc/apt/sources.list.d/mozilla.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y firefox
          firefox --version
          # Install Geckodriver
          wget -q https://github.com/mozilla/geckodriver/releases/download/v0.34.0/geckodriver-v0.34.0-linux64.tar.gz
          tar -xzf geckodriver-v0.34.0-linux64.tar.gz
          sudo mv geckodriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/geckodriver
          geckodriver --version

      - name: Install Python dependencies
        working-directory: ./DamnCRUD/script
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Start application with Docker Compose
        working-directory: ./DamnCRUD
        run: |
          docker compose up -d
          echo "Waiting for MySQL to initialize..."
          sleep 10
          # Wait for MySQL to be ready
          until docker compose exec -T db mysqladmin ping -h localhost -u root -proot123 --silent; do
            echo "Waiting for MySQL..."
            sleep 2
          done
          echo "MySQL is ready!"
          echo "Waiting for web application to be ready..."
          sleep 10
          # Check if application is responding
          curl -f http://localhost:8080/login.php || (docker compose logs && exit 1)

      - name: Run tests in parallel with Pytest
        working-directory: ./DamnCRUD/script
        run: |
          pytest -n auto \
            --html=report.html \
            --self-contained-html \
            --junitxml=junit.xml \
            -v

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            DamnCRUD/script/report.html
            DamnCRUD/script/junit.xml
          retention-days: 30

      - name: Upload test screenshots (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-screenshots
          path: DamnCRUD/script/screenshots/
          retention-days: 7

      - name: Display application logs on failure
        if: failure()
        working-directory: ./DamnCRUD
        run: docker compose logs

      - name: Cleanup
        if: always()
        working-directory: ./DamnCRUD
        run: docker compose down -v

  test-summary:
    name: Test Summary
    needs: test
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: test-results

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: junit.xml
          check_name: Test Results
          comment_title: Test Results Summary
